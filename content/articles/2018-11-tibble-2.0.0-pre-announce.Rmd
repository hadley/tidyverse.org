---
title: "Coming soon: tibble 2.0.0"
slug: tibble-2.0.0-pre-announce
description: >
    The upcoming tibble 2.0.0 release has internal changes relevant to package developers who depend on tibble.
date: 2018-11-21
author: Kirill MÃ¼ller, Jenny Bryan
photo:
  url: https://unsplash.com/photos/yYawh30qf28
  author: Gabriel Porras
categories: [package]
---


```{r setup, include = FALSE}
library(tibble)
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

Version 2.0.0 of the [tibble package](https://tibble.tidyverse.org) is almost ready for release. Tibbles are a modern reimagining of the data frame, keeping what time has shown to be effective, and throwing out what is not, with nicer default output too! Grab the development version with:

```r
devtools::install_github("tidyverse/tibble")
```

We're making a pre-release announcement, because some changes require the attention of maintainers of packages that import or otherwise depend on tibble.
This post describes how to adapt to the next version of tibble and is also an invitation for maintainers to provide feedback before v2.0.0 is finalized and submitted to CRAN.
This blog post is aimed at package developers and those who maintain "production" scripts or apps. A high-level overview of new user-facing features will come in a separate blog post.

## Reverse dependency checks

We ran `R CMD check` for over 3000 CRAN and Bioconductor packages that depend directly or indirectly on the tibble package and compared results obtained with the CRAN versus development version of tibble.
We notified the maintainers of affected packages and aim for a CRAN release before Christmas, just in time for [rstudio::conf](https://www.rstudio.com/conference/).

We made pull requests to implement the necessary changes in several of the most heavily downloaded packages. Based on this experience, this post highlights the problems downstream maintainers are most likely to see and how to solve them.

For the full list of changes, features, and bug fixes, please see the [release notes](https://github.com/tidyverse/tibble/tree/master/NEWS.md).

## Construction and validation

Most end users will likely use the `tibble()` function to construct tibbles.
It checks the input for consistency and makes sure that the returned tibble is valid.
In a package, to quicky construct a tibble from a list if you are very sure that your input is well-formed (i.e., a list of vectors of equal length), you can use `new_tibble()`.
This function also supports the construction of subclasses of tibble through the `subclass()` argument.

The `new_tibble()` function now more closely follow the advice in [adv-r](https://adv-r.hadley.nz/s3.html#s3-classes).
Specifically:

- `new_tibble()` is very fast again and does very little checking itself.
- The new `validate_tibble()` is responsible for validating the structure of a tibble.

This means that the `nrow` argument to `new_tibble()` is now mandatory.
We are aware that this might be the single most disruptive change, but we think that any guesswork here would be detrimental to stability (especially in corner cases) and that this particular problem is very easy to fix.
The `nrow` argument already existed in _tibble_ 1.4.2, so that code that uses it should work in both the released and the upcoming versions of _tibble_.
Please be aware that `nrow` must be passed as named argument, because it comes after the ellipsis `...` in the signature.

```{r error = TRUE}
x <- data.frame(a = 1)

# Old:
new_tibble(x)

# New:
new_tibble(x, nrow = nrow(x)) # if x is a data frame

nrow_x <- NROW(x[[1]]) # if x has at least one column
# nrow_x <- ... # if the number of rows is given elsewhere
new_tibble(x, nrow = nrow_x)
```

## Coercion and name repair

There are some rare legitimate scenarios involving tibbles with empty or duplicate column names.
For instance, after importing data from a foreign format, only inspection of the data might reveal if the column is useful in the first place, or the column names contain data that is about to be converted to a column with `gather()`.
In the vast majority of cases, empty and duplicate names should be avoided, ideally the names should be accessible in R without using backticks.

In _tibble_ 1.4.2, `as_tibble()` had a `validate` argument (with inconsistent default values, and not available for all methods), and there was no way to construct a tibble with duplicate column names through `tibble()`.
The upcoming release aims at improving consistency.
The `as_tibble()` method and the `tibble()` constructor now supports a new `.name_repair` argument that covers most use cases:

- `"minimal"`: No name repair or checks, beyond basic existence.
- `"unique"`: Make sure names are unique and not empty.
- `"check_unique"`: (default value), no name repair, but check they are `unique`.
- `"universal"`: Make the names `unique` and syntactic.
- a function: apply custom name repair (e.g., `.name_repair = make.names` or `.name_repair = ~make.names(., unique = TRUE)` for names in the style of base R).

Name repair is applied always, even when coercing from a matrix or a tibble.
It is now harder (though always possible with `.name_repair = "minimal"`) to construct a tibble with empty or duplicate column names.
See `?repair_names` for details on the new name repair algorithms.

```{r error = TRUE}
m <- cov(unname(iris[-5]))

# Old:
df <- as_tibble(m)
colnames(df) <- letters[1:4]

# New (preferred):
colnames(m) <- letters[1:4]
df <- as_tibble(m)

# New (alternative):
df <- as_tibble(m, .name_repair = "minimal")
colnames(df) <- letters[1:4]
```

The `validate` argument is deprecated and gives a message.
If your code must support _tibble_ < 2.0.0, please use the new code only if `packageVersion("tibble") >= "2.0.0"` .

```{r error = TRUE}
m <- cov(unname(iris[-5]))
df <- new_tibble(list(a = 5, a = 6), nrow = 1)

# Old:
as_tibble(m, validate = TRUE)
as_tibble(df, validate = FALSE)

# New:
as_tibble(m, .name_repair = "unique")
as_tibble(df, .name_repair = "minimal")
```

The existing `tidy_names()` and `set_tidy_names()` functions are soft-deprecated but still available unchanged.
New code should use `.name_repair`.

```{r}
df <- new_tibble(list(a = 5, a = 6), nrow = 1)

# Old:
tidy_names(names(df))
set_tidy_names(df)

# New:
names(as_tibble(
  rlang::rep_named(names(df), list(NA)),
  .name_repair = "universal"
))
as_tibble(df, .name_repair = "universal")
```

Assigning invalid names via `names<-()` seems like a bad idea in general, and now warns once per session.

```{r}
df <- tibble(a = 1)

names(df) <- NA
```

Coercing a vector to a tibble is no longer supported and emits a warning once per session.
It is unclear if the result should be a one-column or a one-row tibble.

```{r}
x <- 1:3
# Old:
as_tibble(x)

# New (>= 2.0.0):
enframe(x, name = NULL)

# New (legacy):
tibble(value = x)
```
