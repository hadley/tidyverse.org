---
title: testthat 2.3.0
author: Hadley Wickham
date: '2019-11-06'
slug: testthat-2-3-0
categories:
  - package
tags:
  - r-lib
  - devtools
  - testthat
photo:
  url: https://unsplash.com/photos/n_vD-7RxA3Q
  author: Roman Kraft
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

We're pumped to announce that [testthat 2.3.0](http://testthat.r-lib.org) is now available on CRAN!
testthat makes it easy to turn your existing informal tests into formal automated tests that you can rerun quickly and easily.
testthat is the most popular unit-testing package for R, and is used by over 4,000 CRAN and Bioconductor packages.
You can learn more about unit testing at <https://r-pkgs.org/tests.html>.

(We didn't write a blog post about testthat 2.2.0 because it only introduced a single, experimental, new feature: `verify_output()`.
It has now matured to the point we think you should also try it out, so it's discussed below.)

Install the latest version of testthat with:

```{r, eval = FALSE}
install.packages("testthat")
```

This release features two main improvements:

-   A general overhaul of condition and error handling.

-   A polished `verify_output()` that is ready for you to use to test your print methods and error messages.

For a complete list of changes, please see the [release notes](https://testthat.r-lib.org/news/index.html#testthat-2-3-0).

```{r setup}
library(testthat)
```

## Errors

The main improvements are mostly behind the scenes: we have overhauled the handling of errors and backtraces so that you should get more informative outputs when tests error unexpectedly or fail.
It's hard to authentically demonstrate this in an RMarkdown document, but if you have an error inside a test, like this:

```{r, eval = FALSE}
f <- function() g()
g <- function() h()
h <- function() stop("This is an error!")

test_that("f() works as expected", {
  expect_equal(f(), 10)
})
```

You'll now get an informative backtrace that should allow you to quickly locate the source of the error:

    test-error.R:6: error: f() works as expected
    This is an error!
    Backtrace:
     1. testthat::expect_equal(f(), 10) tests/testthat/test-error.R:6:2
     4. testthat:::f()
     5. testthat:::g() tests/testthat/test-catch.R:1:5
     6. testthat:::h() tests/testthat/test-catch.R:2:5

The previous version only showed the error message, which wasn't terribly useful!

## `verify_output()`

`verify_output()` is designed to test output aimed at a human, like print methods and error messages.
Here you want to test that the output is useful to a human, but there's obviously no way to do that automatically.
Instead, the best you can do is to check the results with your eyeballs every time the results change.
`verify_output()` is designed to help you do this, making it a type of visual regression test.

You'll need to use `verify_output()` in concert with git.
Whenever the output changes, you'll get a test failure, but to see the change, you'll need to use git.
If the change is correct, commit it with git.
If it's incorrect, fix your code and rerun the tests.
Once fixed, the git diff will disappear.

`verify_output()` works a little like RMarkdown: you give it some R code and it will run it, interleaving the input and output.
For example, imagine we were writing some tests to check that tibbles print correctly:

```{r, include = FALSE}
test_path <- function(x) x
unlink("test-print-dataframe.txt")
unlink("test-print-dataframe-2.txt")
```

```{r}
library(tibble)

test_that("tibbles print usefully", {
  verify_output(test_path("test-print-dataframe.txt"), {
    df1 <- tibble(x = 1:1e6)
    print(df1)
  })
})
```

That test yields a `test-print-dataframe.txt` containing this output:

```{r, results = "asis", echo = FALSE}
cat("```\n")
writeLines(readLines("test-print-dataframe.txt"))
cat("```\n")
```

Unfortunately, there's no way for `verify_output()` to capture comments, so you can instead use bare strings if you want comments to appear in the output.
If you start the comment with `#` it will be formatted as a heading:

```{r}
test_that("tibbles print usefully", {
  verify_output(test_path("test-print-dataframe-2.txt"), {
    "# long tibbles"
    df1 <- tibble(x = 1:1e6)
    print(df1)
    
    "# wide tibbles"
    "not yet written"
  })
})
```

```{r, results = "asis", echo = FALSE}
cat("```\n")
writeLines(readLines("test-print-dataframe-2.txt"))
cat("```\n")
```

`verify_output()` is automatically skipped when run on CRAN.
This avoids false positives because it's very easy to accidentally depend on the code from other packages, and failure does not imply incorrect computation, just a change in presentation.
In other words, `verify_output()` is meant to monitor the evolution of outputs produced by your package rather than checking for regressions.
In this way, it is similar to the [vdiffr](http://vdiffr.r-lib.org/) extension to testthat which uses the same approach to monitor the evolution of plots.

## Acknoweldgements

A big thanks to everyone who helped make this version happen!
[\@aaronrudkin](https://github.com/aaronrudkin), [\@aneudecker](https://github.com/aneudecker), [\@atheriel](https://github.com/atheriel), [\@batpigandme](https://github.com/batpigandme), [\@billdenney](https://github.com/billdenney), [\@cimentadaj](https://github.com/cimentadaj), [\@CorradoLanera](https://github.com/CorradoLanera), [\@cosi1](https://github.com/cosi1), [\@DavisVaughan](https://github.com/DavisVaughan), [\@dtm2451](https://github.com/dtm2451), [\@EmielSchmeink](https://github.com/EmielSchmeink), [\@flying-sheep](https://github.com/flying-sheep), [\@gaborcsardi](https://github.com/gaborcsardi), [\@gdurif](https://github.com/gdurif), [\@hadley](https://github.com/hadley), [\@hughjonesd](https://github.com/hughjonesd), [\@ianmcook](https://github.com/ianmcook), [\@jameslamb](https://github.com/jameslamb), [\@jcheng5](https://github.com/jcheng5), [\@jcubic](https://github.com/jcubic), [\@jennybc](https://github.com/jennybc), [\@jeroen](https://github.com/jeroen), [\@jimhester](https://github.com/jimhester), [\@jozefhajnala](https://github.com/jozefhajnala), [\@jpritikin](https://github.com/jpritikin), [\@keesh0](https://github.com/keesh0), [\@kenahoo](https://github.com/kenahoo), [\@KrishanBhasin](https://github.com/KrishanBhasin), [\@krlmlr](https://github.com/krlmlr), [\@lionel-](https://github.com/lionel-), [\@lorenzwalthert](https://github.com/lorenzwalthert), [\@maxheld83](https://github.com/maxheld83), [\@mcol](https://github.com/mcol), [\@MichaelChirico](https://github.com/MichaelChirico), [\@mkurdej](https://github.com/mkurdej), [\@MLopez-Ibanez](https://github.com/MLopez-Ibanez), [\@moodymudskipper](https://github.com/moodymudskipper), [\@mwmclean](https://github.com/mwmclean), [\@Nachtfeuer](https://github.com/Nachtfeuer), [\@nalzok](https://github.com/nalzok), [\@nbenn](https://github.com/nbenn), [\@oxr463](https://github.com/oxr463), [\@patr1ckm](https://github.com/patr1ckm), [\@richierocks](https://github.com/richierocks), [\@rillig](https://github.com/rillig), [\@sebastiangonsal](https://github.com/sebastiangonsal), [\@shrektan](https://github.com/shrektan), [\@StevenMaude](https://github.com/StevenMaude), [\@tdhock](https://github.com/tdhock), [\@theclue](https://github.com/theclue), [\@tjbell](https://github.com/tjbell), [\@topepo](https://github.com/topepo), [\@torbjorn](https://github.com/torbjorn), [\@trevorld](https://github.com/trevorld), [\@wlandau](https://github.com/wlandau), and [\@zappingseb](https://github.com/zappingseb)
